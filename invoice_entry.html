<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù† Ù…Ø¨ÙŠØ¹Ø§Øª - Earth Pure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-brown: #3C2E2A;
            --accent-gold: #B89C5D;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--light-bg);
            color: var(--primary-brown);
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 1rem; background: #fff; }
            td { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0 !important; border: none !important; text-align: left !important; }
            td::before { content: attr(data-label); font-weight: bold; color: #6b7280; font-size: 0.85rem; }
            .item-input { width: 60% !important; }
        }

        .item-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            text-align: right;
            transition: border-color 0.2s;
        }

        .item-input:focus {
            border-color: var(--accent-gold);
            outline: none;
            box-shadow: 0 0 0 2px rgba(184, 156, 93, 0.1);
        }

        .dir-ltr { direction: ltr; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-gold);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-overlay" class="hidden loading-overlay">
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="font-bold text-gray-600">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-100">
        <div class="bg-gray-800 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-right">
                <h1 class="text-2xl md:text-3xl font-bold">ğŸ“ Ø¨ÙŠØ§Ù† Ù…Ø¨ÙŠØ¹Ø§Øª (ÙØ§ØªÙˆØ±Ø©)</h1>
                <p class="text-sm opacity-80 mt-1">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Earth Pure</p>
            </div>
            <div class="bg-white p-2 rounded-xl flex items-center justify-center">
                <img src="logo.png" alt="Earth Pure" class="h-12 md:h-16 object-contain" onerror="this.src='https://i.ibb.co/p6V8n9X/logo.png'">
            </div>
        </div>

        <div class="p-6 md:p-10">
            <div id="message-box" class="hidden p-4 mb-6 text-center rounded-xl font-bold"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-100">
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¢Ù„ÙŠ)</label>
                    <input type="text" id="invoiceNumber" readonly class="w-full p-3 bg-gray-200 border-none rounded-xl font-bold text-red-600 text-center" value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                    <input type="date" id="invoiceDate" required class="w-full p-3 border border-gray-300 rounded-xl text-center">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤Ù„</label>
                    <input type="text" id="employeeName" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                </div>
                <div class="md:col-span-1 space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="text" id="customerName" required class="w-full p-3 border border-gray-300 rounded-xl" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                    <select id="deliveryMethod" class="w-full p-3 border border-gray-300 rounded-xl bg-white">
                        <option value="Ù†Ù‚Ù„ Ø®Ø§Øµ">Ù†Ù‚Ù„ Ø®Ø§Øµ</option>
                        <option value="Ø´Ø­Ù† Ø³Ø±ÙŠØ¹">Ø´Ø­Ù† Ø³Ø±ÙŠØ¹</option>
                        <option value="ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù„ÙŠØ¯">ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù„ÙŠØ¯</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</label>
                    <select id="collectionMethod" class="w-full p-3 border border-gray-300 rounded-xl bg-white">
                        <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                        <option value="Ø¢Ø¬Ù„">Ø¢Ø¬Ù„</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
                    <button onclick="addItemRow()" class="px-5 py-2 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition shadow-md">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                </div>
                
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 border-b-2 border-accent-gold">
                            <tr>
                                <th class="px-4 py-3 text-sm font-bold w-[5%]">Ù…</th>
                                <th class="px-4 py-3 text-sm font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="px-4 py-3 text-sm font-bold w-[12%]">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th class="px-4 py-3 text-sm font-bold w-[12%] text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th class="px-4 py-3 text-sm font-bold w-[15%] text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="px-4 py-3 text-sm font-bold w-[15%] text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="px-4 py-3 w-[5%]"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-10 pt-8 border-t">
                <div class="md:col-span-2 space-y-2">
                    <label class="block text-sm font-bold text-gray-700">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</label>
                    <div id="notesDisplay" class="w-full p-4 rounded-xl border border-gray-300 bg-gray-50 min-h-[120px] text-sm leading-relaxed whitespace-pre-wrap"></div>
                    <input type="hidden" id="notesBank" value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ/Ø§Ù†Ø³ØªØ§ (126039049001) Ø¨Ù†Ùƒ Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©.">
                    <input type="hidden" id="notesShipping" value="Ø§Ù„Ø´Ø­Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ù…Ù† ÙŠÙˆÙ…ÙŠÙ† Ù„Ø®Ù…Ø³Ø© Ø£ÙŠØ§Ù… / Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©.">
                </div>
                
                <div class="bg-gray-800 p-6 rounded-2xl text-white space-y-4 shadow-xl">
                    <div class="flex justify-between text-sm opacity-80">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                        <span id="subtotalDisplay" class="dir-ltr">0.00 Ø¬.Ù…</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-2">
                            <span>Ø¶Ø±ÙŠØ¨Ø© (14%):</span>
                            <label class="relative inline-flex items-center cursor-pointer scale-90">
                                <input type="checkbox" id="taxToggle" class="sr-only peer" onchange="calculateOverallTotal()">
                                <div class="w-10 h-5 bg-gray-600 rounded-full peer peer-checked:bg-green-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                            </label>
                        </div>
                        <span id="taxDisplay" class="dir-ltr text-red-400 font-bold">0.00 Ø¬.Ù…</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-gray-600 pb-2">
                        <span>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†:</span>
                        <input type="number" id="shippingCost" value="0.00" min="0" step="0.1" oninput="calculateOverallTotal()" 
                               class="w-24 p-1 rounded-lg bg-gray-700 border-none text-left dir-ltr font-bold text-white focus:ring-1 focus:ring-accent-gold">
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-lg font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
                        <span id="totalDisplay" class="text-xl font-black text-green-400 dir-ltr">0.00 Ø¬.Ù…</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-center gap-4 mt-12">
                <button onclick="window.location.href='index.html'" class="px-8 py-4 bg-gray-200 text-gray-700 font-bold rounded-2xl hover:bg-gray-300 transition">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button id="previewButton" onclick="previewInvoice()" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition shadow-lg">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                <button id="saveButton" onclick="saveInvoice()" class="px-8 py-4 bg-amber-600 text-white font-bold rounded-2xl hover:bg-amber-700 transition shadow-lg">ğŸ’¾ Ø­ÙØ¸ ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwt_OncZ-x42XwM5uHzEOiW6eNSs2vrxaqLgFKsp5f2vDskPOqJuQLaMcEICuWgO58pgQ/exec'; 
        let currentEmployeeName = localStorage.getItem('inventoryEmployeeName') || 'Ø§Ù„Ù…ÙˆØ¸Ù';
        let itemCounter = 0;
        const TAX_PERCENTAGE = 0.14;

        const itemsTableBody = document.getElementById('itemsTableBody');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const subtotalDisplay = document.getElementById('subtotalDisplay');
        const taxDisplay = document.getElementById('taxDisplay');
        const totalDisplay = document.getElementById('totalDisplay');
        const taxToggle = document.getElementById('taxToggle');
        const employeeNameInput = document.getElementById('employeeName');
        const messageBox = document.getElementById('message-box');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveButton = document.getElementById('saveButton');
        const previewButton = document.getElementById('previewButton');
        const notesDisplay = document.getElementById('notesDisplay');
        const notesBank = document.getElementById('notesBank').value;
        const notesShipping = document.getElementById('notesShipping').value;
        const shippingCostInput = document.getElementById('shippingCost');

        function formatCurrency(value) {
            return (value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function toggleLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
            saveButton.disabled = show;
        }

        function showMessage(type, text) {
            messageBox.textContent = text;
            messageBox.className = `p-4 mb-6 text-center rounded-xl font-bold ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        async function fetchInvoiceNumber() {
            toggleLoading(true);
            try {
                const response = await fetch(WEB_APP_URL + '?action=getInvoiceNumber');
                const result = await response.json();
                if (result.status === 'success') invoiceNumberInput.value = result.invoiceNumber;
            } catch (error) {
                invoiceNumberInput.value = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            } finally {
                toggleLoading(false);
            }
        }

        function calculateItemTotal(row) {
            const q = parseFloat(row.querySelector('[data-type="quantity"]').value) || 0;
            const p = parseFloat(row.querySelector('[data-type="price"]').value) || 0;
            row.querySelector('[data-type="total"]').textContent = formatCurrency(q * p) + " Ø¬.Ù…";
            calculateOverallTotal();
        }

        function calculateOverallTotal() {
            let sub = 0;
            itemsTableBody.querySelectorAll('tr').forEach(row => {
                const totalCell = row.querySelector('[data-type="total"]');
                if(totalCell) sub += parseFloat(totalCell.textContent.replace(/[^0-9.-]+/g,"")) || 0;
            });

            const shipping = parseFloat(shippingCostInput.value) || 0;
            let tax = taxToggle.checked ? sub * TAX_PERCENTAGE : 0;
            
            subtotalDisplay.textContent = formatCurrency(sub) + ' Ø¬.Ù…';
            taxDisplay.textContent = formatCurrency(tax) + ' Ø¬.Ù…';
            totalDisplay.textContent = formatCurrency(sub + tax + shipping) + ' Ø¬.Ù…';

            notesDisplay.textContent = (taxToggle.checked ? 'â€¢ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (14%).\n' : 'â€¢ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØºÙŠØ± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©.\n') + `â€¢ ${notesShipping}\nâ€¢ ${notesBank}`;
            
            saveButton.disabled = sub <= 0;
            previewButton.disabled = sub <= 0;
        }

        function addItemRow(product = '', unit = '', quantity = '', price = '') {
            itemCounter++;
            const row = itemsTableBody.insertRow();
            row.className = 'border-b border-gray-50';
            row.innerHTML = `
                <td class="px-4 py-3 text-center text-gray-400 text-xs">${itemCounter}</td>
                <td class="px-2 py-3" data-label="Ø§Ù„Ù…Ù†ØªØ¬"><input type="text" data-type="product" value="${product}" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" class="item-input"></td>
                <td class="px-2 py-3" data-label="Ø§Ù„ÙˆØ­Ø¯Ø©"><input type="text" data-type="unit" value="${unit}" placeholder="ÙƒØ¬Ù…/Ù‚Ø·Ø¹Ø©" class="item-input"></td>
                <td class="px-2 py-3" data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"><input type="number" data-type="quantity" value="${quantity}" step="any" oninput="calculateItemTotal(this.closest('tr'))" class="item-input text-center"></td>
                <td class="px-2 py-3" data-label="Ø§Ù„Ø³Ø¹Ø±"><input type="number" data-type="price" value="${price}" step="any" oninput="calculateItemTotal(this.closest('tr'))" class="item-input text-center"></td>
                <td class="px-4 py-3 text-center font-bold dir-ltr" data-type="total" data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">0.00 Ø¬.Ù…</td>
                <td class="px-4 py-3 text-center"><button onclick="this.closest('tr').remove(); calculateOverallTotal();" class="text-red-400 text-xl hover:text-red-600">Ã—</button></td>
            `;
            calculateOverallTotal();
        }

        function collectInvoiceData() {
            const items = Array.from(itemsTableBody.querySelectorAll('tr')).map(row => ({
                product: row.querySelector('[data-type="product"]').value.trim(),
                unit: row.querySelector('[data-type="unit"]').value.trim(),
                quantity: parseFloat(row.querySelector('[data-type="quantity"]').value) || 0,
                price: parseFloat(row.querySelector('[data-type="price"]').value) || 0,
                total: parseFloat(row.querySelector('[data-type="total"]').textContent.replace(/[^0-9.-]+/g,"")) || 0
            }));

            if (items.some(i => !i.product || i.quantity <= 0)) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");

            return {
                action: 'saveInvoice',
                invoiceNumber: invoiceNumberInput.value,
                invoiceDate: document.getElementById('invoiceDate').value,
                customerName: document.getElementById('customerName').value.trim(),
                employeeName: employeeNameInput.value.trim(),
                deliveryMethod: document.getElementById('deliveryMethod').value,
                collectionMethod: document.getElementById('collectionMethod').value,
                notes: notesDisplay.textContent,
                subtotal: parseFloat(subtotalDisplay.textContent.replace(/[^0-9.-]+/g,"")),
                taxAmount: parseFloat(taxDisplay.textContent.replace(/[^0-9.-]+/g,"")),
                shippingCost: parseFloat(shippingCostInput.value) || 0,
                total: parseFloat(totalDisplay.textContent.replace(/[^0-9.-]+/g,"")),
                items: items
            };
        }

        async function saveInvoice() {
            try {
                const data = collectInvoiceData();
                toggleLoading(true);
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data) });
                const result = await response.json();
                if (result.status === 'success') {
                    data.invoiceNumber = result.invoiceNumber;
                    sessionStorage.setItem('tempInvoiceData', JSON.stringify(data));
                    window.open('invoice_preview.html', '_blank');
                    initializeInvoiceForm();
                } else showMessage('error', result.message);
            } catch (e) { showMessage('error', e.message); } finally { toggleLoading(false); }
        }

        function previewInvoice() {
            try {
                const data = collectInvoiceData();
                sessionStorage.setItem('tempInvoiceData', JSON.stringify(data));
                window.open('invoice_preview.html', '_blank');
            } catch (e) { showMessage('error', e.message); }
        }

        function initializeInvoiceForm() {
            document.getElementById('invoiceDate').valueAsDate = new Date();
            employeeNameInput.value = currentEmployeeName;
            document.getElementById('customerName').value = '';
            shippingCostInput.value = '0.00';
            itemsTableBody.innerHTML = '';
            itemCounter = 0;
            addItemRow();
            fetchInvoiceNumber();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('inventoryEmployeeId')) { window.location.href = 'inventory_login.html'; return; }
            initializeInvoiceForm();
        });
    </script>
</body>
</html>