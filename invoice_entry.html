<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù† Ù…Ø¨ÙŠØ¹Ø§Øª (ÙØ§ØªÙˆØ±Ø©)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªÙ†Ø§Ø³Ù‚Ø© Ù…Ø¹ Ù‡ÙˆÙŠØ© Ø§Ù„Ø´Ø¹Ø§Ø± (Ø°Ù‡Ø¨ÙŠØŒ Ø¨Ù†ÙŠØŒ ÙˆØ£Ù„ÙˆØ§Ù† Ù…Ø­Ø§ÙŠØ¯Ø©) */
        :root {
            --primary-dark-brown: #3C2E2A;
            --accent-gold: #B89C5D;
            --light-bg: #f8f8f8;
            --white: #ffffff;
            --input-border: #ddd;
            --button-bg: var(--accent-gold);
            --button-hover: #a18b52;
            --header-bg: var(--primary-dark-brown);
            --text-color: var(--primary-dark-brown);
            --error-bg: #ffe0e0;
            --error-text: #cc0000;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            direction: rtl;
        }
        .item-input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
            width: 100%;
            text-align: right;
            font-size: 0.95em;
        }
        .dir-ltr { direction: ltr; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-gold);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="invoice-container w-full max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl border-t-8 border-b-8 border-gray-600">
        <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Earth Pure" class="max-w-[150px] mx-auto mb-5">
        <h1 class="text-3xl font-bold text-center mb-2 text-gray-700">ğŸ“ Ø¨ÙŠØ§Ù† Ù…Ø¨ÙŠØ¹Ø§Øª (ÙØ§ØªÙˆØ±Ø©)</h1>
        <p class="text-center text-sm mb-8 text-gray-500">Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</p>

        <div id="loading-overlay" class="hidden loading-overlay">
            <div class="spinner"></div>
        </div>

        <div id="message-box" class="hidden p-3 mb-4 text-center rounded-lg font-medium"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8 p-4 border rounded-lg bg-gray-50">
            <div>
                <label for="invoiceNumber" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¢Ù„ÙŠ)</label>
                <input type="text" id="invoiceNumber" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-200 font-bold text-red-600" value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...">
            </div>
            <div>
                <label for="invoiceDate" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                <input type="date" id="invoiceDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <div>
                <label for="customerName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨)</label>
                <input type="text" id="customerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            </div>
            <div>
                <label for="employeeName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ø¨Ø§Ø¦Ø¹ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
                <input type="text" id="employeeName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">
            </div>
            <div>
                <label for="deliveryMethod" class="block text-sm font-medium text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ù„Ø´Ø­Ù†)</label>
                <select id="deliveryMethod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    <option value="Ù†Ù‚Ù„ Ø®Ø§Øµ">Ù†Ù‚Ù„ Ø®Ø§Øµ</option>
                    <option value="Ø´Ø­Ù† Ø³Ø±ÙŠØ¹">Ø´Ø­Ù† Ø³Ø±ÙŠØ¹</option>
                    <option value="ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù„ÙŠØ¯">ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù„ÙŠØ¯</option>
                </select>
            </div>
            <div>
                <label for="collectionMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ØµÙŠÙ„:</label>
                <select id="collectionMethod" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                    <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                    <option value="Ø¢Ø¬Ù„">Ø¢Ø¬Ù„</option>
                </select>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-3 text-gray-700 text-right">Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
        <div class="overflow-x-auto border rounded-lg shadow-sm mb-4">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[5%]">Ù…</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[35%]">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[15%]">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[15%]">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[15%]">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider w-[10%]">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-[5%]">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        <button onclick="addItemRow()" class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150 mb-6">
            + Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
        </button>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="md:col-span-2">
                <label for="notes" class="block text-sm font-medium text-gray-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©):</label>
                <div id="notesDisplay" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-4 border bg-white min-h-[100px] text-sm text-gray-700 text-right whitespace-pre-wrap">
                    </div>
                <input type="hidden" id="notesBank" value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ/Ø§Ù†Ø³ØªØ§ (126039049001) Ø¨Ù†Ùƒ Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©.">
                <input type="hidden" id="notesShipping" value="Ø§Ù„Ø´Ø­Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ù…Ù† ÙŠÙˆÙ…ÙŠÙ† Ù„Ø®Ù…Ø³Ø© Ø£ÙŠØ§Ù… / Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©.">
            </div>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                <div class="flex justify-between mb-2 border-b pb-2">
                    <span class="font-medium text-gray-700">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                    <span id="subtotalDisplay" class="font-semibold text-lg text-gray-800 dir-ltr">0.00 Ø¬.Ù….</span>
                </div>
                
                <div class="flex items-center justify-between mb-3 border-b pb-2">
                    <div class="flex items-center gap-2">
                        <span class="font-medium text-gray-700">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (14%):</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="taxToggle" class="sr-only peer" onchange="calculateOverallTotal()">
                            <div class="w-11 h-6 bg-gray-400 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <span id="taxDisplay" class="font-semibold text-lg text-red-600 dir-ltr">0.00 Ø¬.Ù….</span>
                </div>
                
                <div class="flex justify-between mb-3 border-b pb-2 items-center">
                    <label for="shippingCost" class="font-medium text-gray-700 block">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†:</label>
                    <input type="number" id="shippingCost" value="0.00" min="0" step="0.01" oninput="calculateOverallTotal()" 
                           class="w-32 rounded-md border-gray-300 shadow-sm p-1 border text-left dir-ltr font-semibold text-gray-800">
                </div>
                
                <div class="flex justify-between">
                    <span class="font-bold text-xl text-gray-800">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
                    <span id="totalDisplay" class="font-bold text-xl text-green-600 dir-ltr">0.00 Ø¬.Ù….</span>
                </div>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-8">
            <button onclick="window.location.href='index.html'" class="px-6 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition duration-150">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button id="previewButton" onclick="previewInvoice()" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150">
                Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            </button>
            <button id="saveButton" onclick="saveInvoice()" class="px-6 py-3 bg-amber-600 text-white font-medium rounded-lg hover:bg-amber-700 transition duration-150">
                Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            </button>
        </div>
    </div>

    <script>
        // **Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©: ÙŠØ¬Ø¨ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨ Ù‡Ù†Ø§**
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwt_OncZ-x42XwM5uHzEOiW6eNSs2vrxaqLgFKsp5f2vDskPOqJuQLaMcEICuWgO58pgQ/exec'; 
        
        let currentEmployeeName = localStorage.getItem('inventoryEmployeeName') || 'Ø§Ù„Ù…ÙˆØ¸Ù';
        let itemCounter = 0;
        const TAX_PERCENTAGE = 0.14; // 14% Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©

        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const itemsTableBody = document.getElementById('itemsTableBody');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const subtotalDisplay = document.getElementById('subtotalDisplay');
        const taxDisplay = document.getElementById('taxDisplay');
        const totalDisplay = document.getElementById('totalDisplay');
        const taxToggle = document.getElementById('taxToggle');
        const employeeNameInput = document.getElementById('employeeName');
        const messageBox = document.getElementById('message-box');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveButton = document.getElementById('saveButton');
        const previewButton = document.getElementById('previewButton');
        const notesDisplay = document.getElementById('notesDisplay'); // **Ø¬Ø¯ÙŠØ¯: Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª**
        const notesBank = document.getElementById('notesBank').value;
        const notesShipping = document.getElementById('notesShipping').value;
        const shippingCostInput = document.getElementById('shippingCost'); // **Ø¬Ø¯ÙŠØ¯: Ø­Ù‚Ù„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†**

        // *************** ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ***************

        function formatCurrency(value) {
            return (value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function toggleLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
            saveButton.disabled = show;
            previewButton.disabled = show;
        }

        function showMessage(type, text) {
            messageBox.textContent = text;
            messageBox.className = `p-3 mb-4 text-center rounded-lg font-medium ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.classList.remove('hidden');
        }

        // *************** ÙˆØ¸Ø§Ø¦Ù API ***************

        async function fetchInvoiceNumber() {
            if (WEB_APP_URL.includes('https://script.google.com/macros/s/AKfycbyaVNr7b2AWTPKj8VBHMFgTeF63-fPqE80LVgGdS6qhPjBAjeJxLAda-zhBhoYO7XLIXQ/exec')) {
                invoiceNumberInput.value = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ø£ÙˆÙ„Ø§Ù‹!';
                return;
            }
            toggleLoading(true);
            try {
                const response = await fetch(WEB_APP_URL + '?action=getInvoiceNumber', { method: 'GET' });
                const result = await response.json();

                if (result.status === 'success') {
                    invoiceNumberInput.value = result.invoiceNumber;
                } else {
                    invoiceNumberInput.value = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù…';
                    showMessage('error', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${result.message}`);
                }
            } catch (error) {
                invoiceNumberInput.value = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                showMessage('error', `Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // *************** ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ***************
        
        function calculateItemTotal(row) {
            const quantity = parseFloat(row.querySelector('[data-type="quantity"]').value) || 0;
            const price = parseFloat(row.querySelector('[data-type="price"]').value) || 0;
            const total = (quantity * price);

            row.querySelector('[data-type="total"]').textContent = formatCurrency(total);
            calculateOverallTotal();
        }

        function generateNotesText(taxApplied) {
            let taxMessage = taxApplied 
                             ? 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (14%).'
                             : 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØºÙŠØ± Ø´Ø§Ù…Ù„Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©.';
            
            // Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ÙÙŠ Ù†Øµ ÙˆØ§Ø­Ø¯ Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            return `${taxMessage}\n${notesShipping}\n${notesBank}`;
        }


        function calculateOverallTotal() {
            let grandSubtotal = 0;
            const itemRows = itemsTableBody.querySelectorAll('tr');

            itemRows.forEach(row => {
                const totalCell = row.querySelector('[data-type="total"]');
                if(totalCell) {
                    const totalValue = parseFloat(totalCell.textContent.replace(/[^0-9.-]+/g,"")) || 0; 
                    grandSubtotal += totalValue;
                }
            });

            const applyTax = taxToggle.checked; 
            const shippingCost = parseFloat(shippingCostInput.value) || 0; // **Ø¬Ø¯ÙŠØ¯: Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†**
            let taxAmount = 0;
            let finalTotal = grandSubtotal;

            if (applyTax) {
                taxAmount = grandSubtotal * TAX_PERCENTAGE;
                finalTotal += taxAmount;
            }
            
            // **Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¥Ø¶Ø§ÙØ© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ**
            finalTotal += shippingCost;


            // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
            subtotalDisplay.textContent = formatCurrency(grandSubtotal) + ' Ø¬.Ù….';
            taxDisplay.textContent = formatCurrency(taxAmount) + ' Ø¬.Ù….';
            totalDisplay.textContent = formatCurrency(finalTotal) + ' Ø¬.Ù….';

            // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©**
            notesDisplay.textContent = generateNotesText(applyTax);
            
            // ØªÙ…ÙƒÙŠÙ†/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
            saveButton.disabled = grandSubtotal <= 0;
            previewButton.disabled = grandSubtotal <= 0;
        }

        // *************** ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ ***************
        
        function addItemRow(product = '', unit = '', quantity = '', price = '') {
            itemCounter++;
            const row = itemsTableBody.insertRow();
            row.id = `row-${itemCounter}`;
            row.className = 'item-row border-b border-gray-100';

            row.innerHTML = `
                <td class="px-3 py-2 text-center text-gray-500">${itemCounter}</td>
                <td class="px-3 py-2"><input type="text" data-type="product" value="${product}" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" class="item-input"></td>
                <td class="px-3 py-2"><input type="text" data-type="unit" value="${unit}" placeholder="ÙˆØ­Ø¯Ø©" class="item-input"></td>
                <td class="px-3 py-2"><input type="number" data-type="quantity" value="${quantity}" min="0.01" step="any" class="item-input text-left" required></td>
                <td class="px-3 py-2"><input type="number" data-type="price" value="${price}" min="0.01" step="0.01" class="item-input text-left" required></td>
                <td data-type="total" class="px-3 py-2 font-semibold text-left dir-ltr text-gray-800">
                    ${formatCurrency(0)}
                </td>
                <td class="px-3 py-2 text-center">
                    <button onclick="deleteItemRow(this)" class="text-red-600 hover:text-red-800 transition duration-150">
                        ğŸ—‘ï¸
                    </button>
                </td>
            `;
            // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const newRow = document.getElementById(row.id);
            newRow.querySelector('[data-type="quantity"]').addEventListener('input', () => calculateItemTotal(newRow));
            newRow.querySelector('[data-type="price"]').addEventListener('input', () => calculateItemTotal(newRow));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ… Ø£ÙˆÙ„ÙŠØ©
            if (quantity && price) calculateItemTotal(newRow);
        }

        function deleteItemRow(button) {
            const row = button.closest('tr');
            if(row) {
                 row.remove();
                 calculateOverallTotal();
            }
        }

        function collectInvoiceData() {
            const items = [];
            const rows = itemsTableBody.querySelectorAll('tr');
            let isValid = true;

            rows.forEach(row => {
                const product = row.querySelector('[data-type="product"]').value.trim();
                const unit = row.querySelector('[data-type="unit"]').value.trim();
                const quantityInput = row.querySelector('[data-type="quantity"]');
                const priceInput = row.querySelector('[data-type="price"]');
                const totalText = row.querySelector('[data-type="total"]').textContent;
                
                const quantity = parseFloat(quantityInput.value);
                const price = parseFloat(priceInput.value);
                const total = parseFloat(totalText.replace(/[^0-9.-]+/g,""));

                if (!product || quantity <= 0 || price < 0 || isNaN(quantity) || isNaN(price)) {
                    isValid = false;
                    row.classList.add('bg-red-100');
                } else {
                    row.classList.remove('bg-red-100');
                }

                items.push({
                    product: product,
                    unit: unit,
                    quantity: quantity,
                    price: price,
                    total: total,
                });
            });

            if (!isValid) {
                 throw new Error("ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙÙŠ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù.");
            }
            if (items.length === 0) {
                 throw new Error("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙØ§ØªÙˆØ±Ø©.");
            }
            
            const subtotal = parseFloat(subtotalDisplay.textContent.replace(/[^0-9.-]+/g,""));
            const taxAmount = parseFloat(taxDisplay.textContent.replace(/[^0-9.-]+/g,""));
            const total = parseFloat(totalDisplay.textContent.replace(/[^0-9.-]+/g,""));
            const shippingCost = parseFloat(shippingCostInput.value) || 0; // **Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¬Ù…Ø¹ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†**

            const customerName = document.getElementById('customerName').value.trim();
            const employeeName = document.getElementById('employeeName').value.trim();
            const notes = notesDisplay.textContent; 
            
            if (!customerName) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„.");
            if (!employeeName) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù.");

            const taxToggle = document.getElementById('taxToggle');
            const taxRateApplied = taxToggle.checked ? '14% Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©' : '0% ØºÙŠØ± Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©'; 

            return {
                action: 'saveInvoice',
                invoiceNumber: invoiceNumberInput.value,
                invoiceDate: document.getElementById('invoiceDate').value,
                customerName: customerName,
                employeeName: employeeName, 
                deliveryMethod: document.getElementById('deliveryMethod').value,
                collectionMethod: document.getElementById('collectionMethod').value,
                notes: notes, 
                subtotal: subtotal,
                taxAmount: taxAmount, 
                shippingCost: shippingCost, // **Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¥Ø±Ø³Ø§Ù„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† Ø¥Ù„Ù‰ Ø§Ù„Ù€ Apps Script**
                taxRateApplied: taxRateApplied, 
                total: total,
                items: items
            };
        }

        // *************** ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ***************

        async function saveInvoice() {
            try {
                const invoiceData = collectInvoiceData();
                
                toggleLoading(true);

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoiceData)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
                    invoiceData.invoiceNumber = result.invoiceNumber;
                    sessionStorage.setItem('tempInvoiceData', JSON.stringify(invoiceData));
                    
                    // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                    window.open('invoice_preview.html', '_blank');
                    initializeInvoiceForm();

                } else {
                    showMessage('error', `Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${result.message}`);
                }

            } catch (error) {
                showMessage('error', `Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        function previewInvoice() {
            try {
                const invoiceData = collectInvoiceData();
                sessionStorage.setItem('tempInvoiceData', JSON.stringify(invoiceData));
                
                // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                window.open('invoice_preview.html', '_blank');

            } catch (error) {
                showMessage('error', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: ${error.message}`);
            }
        }

        function initializeInvoiceForm() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            document.getElementById('invoiceDate').value = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ¬Ø¹Ù„Ù‡ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            employeeNameInput.value = currentEmployeeName;
            employeeNameInput.removeAttribute('readonly'); 
            
            document.getElementById('customerName').value = '';
            shippingCostInput.value = '0.00'; // **Ø¬Ø¯ÙŠØ¯: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†**
            
            // Ù…Ø³Ø­ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¶Ø§ÙØ© ØµÙ ÙØ§Ø±Øº
            itemsTableBody.innerHTML = '';
            addItemRow(); 

            calculateOverallTotal();
            fetchInvoiceNumber(); // Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
        }

        // *************** ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ ***************
        document.addEventListener('DOMContentLoaded', function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡
            if (!localStorage.getItem('inventoryEmployeeId')) {
                window.location.href = 'inventory_login.html';
                return;
            }
            
            initializeInvoiceForm();
        });
    </script>
</body>
</html>